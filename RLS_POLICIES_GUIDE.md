# RLS Policies Guide

## Overview

Row-Level Security (RLS) policies in Supabase filter database query results based on the authenticated user's claims and database relationships.

## JWT Claims Used in RLS Policies

The Supabase JWT token (generated by the backend) contains these claims:

```json
{
  "sub": "user_35a1IYAbyuT5Mc53qfbs992K8sB",      // Clerk user ID (from JWT Subject)
  "user_id": "user_35a1IYAbyuT5Mc53qfbs992K8sB", // Custom claim for RLS
  "email": "user@example.com",
  "role": "admin",                                 // "admin", "user", or "organizer"
  "iss": "https://supabase.io/auth/v1",
  "aud": ["authenticated"],
  "iat": 1700000000,
  "exp": 1700003600
}
```

The RLS policies check `auth.jwt() ->> 'role'` and `auth.jwt() ->> 'sub'` to determine access.

## Current RLS Policies

### Leagues Table

```sql
-- Admins can read all leagues (all statuses)
CREATE POLICY leagues_select_admin ON leagues
  FOR SELECT
  USING (
    auth.jwt() ->> 'role' = 'admin'
  );

-- Regular users can read:
-- 1. Approved leagues (status = 'approved')
-- 2. Their own submissions (created_by = current user's sub)
-- 3. Leagues from organizations they belong to
CREATE POLICY leagues_select_user ON leagues
  FOR SELECT
  USING (
    status = 'approved'
    OR created_by = (auth.jwt() ->> 'sub')
    OR org_id IN (
      SELECT org_id FROM user_organizations
      WHERE user_id = (auth.jwt() ->> 'sub') AND is_active = true
    )
  );
```

**Access Matrix:**

| User Type | Approved Leagues | Own Submissions | Org Leagues | All Leagues |
|-----------|-----------------|-----------------|-------------|------------|
| Admin     | ✓               | ✓               | ✓           | ✓          |
| Organizer | ✓               | ✓               | ✓           | ✗          |
| User      | ✓               | ✓               | ✗           | ✗          |

## How to Test RLS

### 1. Verify JWT Token Content

When the frontend fetches a Supabase token, it should contain the role and sub claims. Check browser console:

```javascript
// In frontend, after token is fetched
const parts = token.split('.');
const payload = JSON.parse(atob(parts[1]));
console.log('JWT Claims:', payload);
// Should show: { sub: "user_...", role: "admin", email: "..." }
```

### 2. Set User Role to Admin

```bash
# Backend endpoint to update user role
curl -X PATCH http://localhost:8080/v1/auth/user/{userId}/role \
  -H "Authorization: Bearer {clerkToken}" \
  -H "Content-Type: application/json" \
  -d '{"role":"admin"}'
```

### 3. Test League Query

Once a user has the `admin` role, they should be able to see all leagues via Supabase client:

```typescript
const { data, error } = await supabaseClient
  .from('leagues')
  .select('*')
  .order('created_at', { ascending: false });

// For admins: should return ALL leagues (approved, pending, rejected)
// For users: should return only approved + their own leagues
```

### 4. Set Up User-Organization Membership

To test organizer access:

```typescript
// Insert a user-organization relationship
const { data, error } = await supabaseClient
  .from('user_organizations')
  .insert({
    user_id: 'clerk_user_id',
    org_id: 'organization_uuid',
    role_in_org: 'owner',
    is_active: true
  });
```

Then that user should be able to see:
- All approved leagues
- Their own league submissions
- Leagues from their organization(s)

## Troubleshooting RLS Issues

### Issue: Admins not seeing all leagues

**Check:**
1. Is user role actually "admin" in the database?
   ```sql
   SELECT id, email, role FROM users WHERE id = 'user_...';
   ```

2. Is JWT token being generated with correct role?
   ```bash
   # Check backend logs when token is generated
   # Should see: Creating Supabase token claims role=admin
   ```

3. Is `auth.jwt()` context available?
   - RLS policies require the JWT to be set in the Supabase client
   - Check that `setSupabaseToken()` was called successfully

### Issue: Organizers not seeing their org's leagues

**Check:**
1. Does `user_organizations` entry exist?
   ```sql
   SELECT * FROM user_organizations
   WHERE user_id = 'user_...' AND is_active = true;
   ```

2. Is `is_active` set to `true`?

3. Does the league's `org_id` match the user's organization?

### Issue: RLS policy rejecting valid queries

**Common causes:**
- JWT not set in Supabase client (call `setSupabaseToken()`)
- Wrong claim names in policy (`sub` vs `user_id`)
- Token expired (should auto-refresh 5 minutes before expiry)
- Missing user record in database

## Frontend Implementation

The frontend uses these hooks to query data with RLS:

```typescript
// Sports (everyone can read)
useSports()

// Venues (everyone can read)
useVenues()

// Leagues (RLS filters based on role/membership)
useLeaguesReadOnly()
useApprovedLeagues()
useLeagueById(id)

// Organizations (RLS filters based on membership)
useUserOrganizations()
useAllOrganizations()
```

Each hook:
1. Calls `useSupabaseToken()` to get JWT token
2. Sets token in Supabase client via `setSupabaseToken()`
3. Makes query to Supabase PostgREST API
4. RLS policies automatically filter results based on JWT claims

## Next Steps

1. **Test with real user accounts:**
   - Create users in Clerk
   - Register them in the backend
   - Set their roles and organization memberships

2. **Add admin setup UI:**
   - Allow admins to update other users' roles
   - Allow admins to manage user-organization relationships

3. **Add audit logging:**
   - Log all RLS policy denials
   - Track who accessed what data
