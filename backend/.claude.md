# Backend (Go) Rules

## Structure
```
/cmd/api - Entry & router
/internal - Auth, Sports, Venues, Leagues, Organizations
/supabase/migrations - Database changes
```

## Architecture
- **3-Layer**: Repository → Service → Handler
- **Router**: Chi with middleware groups (public → JWT-protected → admin-only)
- **Org Pattern**: Many-to-many via `user_organizations` table. Org context from URL, not session.
- **Access Control**: Services verify via `orgService.VerifyUserOrgAccess(userID, orgID)`
- **Organization IDs**: UUIDs (prevents enumeration). UUID generated in repository: `uuid.New().String()`

## Key Patterns
- **Error wrapping**: `fmt.Errorf("context: %w", err)` + structured logging with slog
- **Context with timeout**: `context.WithTimeout(context.Background(), 5*time.Second)`
- **Handlers**: Extract userID from `X-Clerk-User-ID` header, pass to service
- **Nullable fields**: Use pointers (`*string`, `*time.Time`) to distinguish null from zero value
- **Draft save**: Use JSONB + UPSERT (`ON CONFLICT DO UPDATE`)
- **Soft deletes**: Use `is_deleted` boolean + `deleted_at` timestamp, filter in queries
- **Validation**: `h.validator.Struct(req)` in handler before passing to service
- **JWT middleware**: Sets `X-Clerk-User-ID` header, downstream handlers read it
- **Enums**: Type-safe constants with `.IsValid()` and `.String()` methods

## Clerk
- Use SDK (not HTTP calls)
- Metadata: only role (org data in database)
- Email: Clerk's native field is source of truth
- No organization context in Clerk - handled in database

## Database
- Migrations: timestamp filename + comments + indexes
- JSONB for flexible data (e.g., draft data)
- Foreign keys with ON DELETE CASCADE
- Use `IF NOT EXISTS` for safe re-runs

## Common Methods
- **Get user data**: Extract from header, verify access, query service
- **Update with optional fields**: Use COALESCE in SQL for partial updates
- **Link user to org**: Include `created_at`, `updated_at`, `joined_at` in INSERT
- **List user orgs**: Filter by `is_active = true AND org.is_deleted = false`

## Dependencies
`chi/v5`, `pgx/v5`, `clerk-sdk-go`, `validator/v10`, `uuid`, `slog`
