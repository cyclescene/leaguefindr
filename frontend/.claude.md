# Frontend (Next.js 16) Rules

## Structure
```
/app - App router (routes: (auth), (admin), /, /[orgId])
/components - shadcn/ui + custom forms
/lib/schemas - Zod validation + type inference
/hooks - Data fetching (SWR) and custom hooks
/types - TypeScript type definitions
```

## Key Patterns

### Forms
- **Validation**: React Hook Form + Zod resolver
- **Token**: Use `useAuth().getToken()` (NOT `useUser().getIdToken()`)
- **Headers**: Always send `Authorization: Bearer ${token}`
- **State**: useState for dynamic arrays/dates, form.setValue() to sync
- **Submission**: Prevent duplicates with `isSubmitting`, handle errors in try/catch

### Data Fetching
- **GET requests**: Use SWR custom hooks in `/hooks/`
- **Mutations**: Use raw fetch, call `mutate()` after to revalidate
- **Auth**: useAuth().getToken() for token, store in hook
- **Caching**: SWR with `revalidateOnFocus: false`, `revalidateOnReconnect: true`

### Components
- **Use shadcn/ui**: Button, Input, Dialog, Card, Tabs, Badge, etc.
- **Props interface**: Define interface, pass to component
- **Styling**: Tailwind + `className` prop, use `!` flag for overrides
- **Dialog sizing**: `!max-w-5xl w-[85vw]` for responsive, `max-h-[95vh] overflow-y-auto` for scroll

### Middleware (proxy.ts)
- Flow: No userId → /signin → !verified → /verify-email → verified → route allowed
- Read from `sessionClaims` only (no API calls)
- Route matchers for protected paths

### Clerk Auth
- useAuth() for form submissions: `const { getToken } = useAuth()`
- Always null-check token before sending
- Clerk provides native email verification field

### Special Patterns

#### Multi-Section Form
- Organize fields: `<div className="border-t pt-6"><h3>...</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">`
- Use `watch()` for real-time calculations with `math.Ceil()` for rounding

#### Date Fields
- Separate state: `useState<Date | undefined>()`
- Convert: `format(date, 'yyyy-MM-dd')` for API, `parse(string, 'yyyy-MM-dd', new Date())` for display

#### Dynamic Arrays
- Keep separate state: `const [items, setItems] = useState([])`
- Sync with form: `setValue('field', updated)`
- Add/remove with icons (Plus, X from lucide)

#### Draft Load/Save
- Load on mount: check orgId, fetch from `/v1/organizations/user`
- Parse dates, restore arrays, call `setValue()` for each field
- Save draft: collect all values, POST to `/v1/drafts`, call `mutate()` to refresh
- Delete draft after successful submission

### Components to Know
- **Button**: `className="bg-brand-dark hover:bg-brand-dark/90 text-white"`
- **Input**: `className="border-brand-light focus:ring-brand-dark"`
- **Dialog**: Use `DialogHeader`, `DialogTitle`, `DialogDescription`
- **Card**: `CardHeader`, `CardTitle`, `CardContent`

### Accessibility
- Form fields: `id`, `htmlFor` on labels, `aria-invalid` on invalid inputs
- Dialogs: Use DialogTitle (can hide with sr-only)
- Error messages: Display inline under fields

## Environment
- `NEXT_PUBLIC_API_URL` - Backend URL
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk public key

## Dependencies
`next@16`, `@clerk/nextjs`, `react-hook-form`, `zod`, `tailwindcss`, `date-fns`, `swr`, `lucide-react`

## Commands
- Dev: `pnpm dev`
- Build: `pnpm build`
- **Package manager: ALWAYS use `pnpm` - never use npm or yarn**

## Important Reminders
- **Always use useAuth().getToken()** for form authentication
- **Always filter deleted orgs** in queries (is_deleted = false)
- **Use SWR for all GET requests** (not raw fetch)
- **Update SWR cache after mutations** with mutate()
- **Use shadcn components** for consistency
